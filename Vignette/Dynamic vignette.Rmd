---
title: 'Extended vignette for **EEAaq: Handle Air Quality Data from the European Environment Agency Data Portal**'
author:
- Paolo Maranzano, University of Milano-Bicocca, Italy, paolo.maranzano@unimib.it
- Riccardo Borgoni, University of Milano-Bicocca, Italy, riccardo.borgoni@unimib.it
- Agostino Tassan Mazzocco, University of Milano-Bicocca, Italy
- Samir Doghmi, University of Milano-Bicocca, Italy
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    df_print: paged
  pdf_document:
    fig_caption: true
    keep_md: true
subtitle: Extended vignette
---

The **EEAaq package** allows users to retrieve air quality data for a user-defined vector of stations ID (to be pre-filtered by the user before the query), pollutants, and time periods in a single request. Queries are submitted to EEA air quality data flow as lists, which enables flexibility in specifying combinations of parameters.

```{r setup}
library(EEAaq)
library(tidyverse)
```


# EEAaq_get_data
Below we demonstrate the use of query by using different combinations of user-defined arguments.

### Retrieve stations currently active in the municipality of Milano (Italy) measuring NO$_2$ concentrations
```{r}
IDstats <- EEAaq_get_stations(byStation = FALSE, complete = TRUE)
IDstats_MI <- IDstats %>%
  filter(Country %in% c("Italy"),          # Country
         LAU_NAME %in% c("Milano"),        # City/municipality
         AirPollutant %in% c("NO2"),       # Pollutant of interest
         is.na(OperationalActivityEnd))    # Currently operating
```

### Retrieve NO$_2$ data for Milano according to the IDs of filtered stations
```{r}
data_lau <- EEAaq::EEAaq_get_data(
  IDstations = unique(IDstats_MI$AirQualityStationEoICode),   # List of stations
  pollutants = "PM10",      # Pollutant 
  from = "2022-01-01",      # Start date
  to = "2023-12-31",        # End date
  verbose = FALSE           # Print detailed progress
)
```

```{r}
# Preview the first few rows of the dataset
head(data_lau)
```


### Retrieve PM$_{10}$ and NO$_2$ data for user-defined a specific macroregion (see the Eurostat classification NUTS-1)
```{r}
# Identify the names of the areas from which to download the data
zones <- c("RÃ©gion de Bruxelles-Capitale/Brussels Hoofdstedelijk Gewest",
           "Vlaams Gewest",
           "West-Nederland",
           "Zuid-Nederland")

IDstats_Benelux <- IDstats %>%
  filter(NUTS1 %in% zones,                   # Regions of interest
    AirPollutant %in% c("NO2","PM10"),   # Pollutants of interest
    is.na(OperationalActivityEnd)        # Currently operating
  )

# Download the corresponding data
data <- EEAaq_get_data(
  IDstations = unique(IDstats_Benelux$AirQualityStationEoICode),   # List of stations
  pollutants = c("NO2", "PM10"),     # Pollutant 
  from = "2023-01-01",               # Start date
  to = "2023-12-31",                 # End date
  verbose = FALSE                    # Print detailed progress
)
```


```{r}
unique(data$AirQualityStationEoICode)
```

```{r}
knitr::kable(head(data,20))
```

\
**Note 1**:
Notice that, if the selected stations have a valid value for *CITY_NAME* (i.e., not NULL in the dataset), the function will enquire the EEA database directly with improved-speed filters (in this case, the download require a short time). If no valid CITY_NAME is associated with the stations (i.e., it is NULL for at least one station), the function attempts to retrieve all available data for the entire country and subsequently filter for the specified stations (in this case, the download can require a longer time).
\

**Note 2**:
For very small towns or certain countries such as Turkey or Albania, data may not currently be available in the dataset.This limitation reflects the data unavailability at the [EEA Air Quality Viewer](https://discomap.eea.europa.eu/App/AQViewer/index.html?fqn=Airquality_Dissem.b2g.AirQualityStatistics).
\



# EEAaq map stations
`EEAaq_map_stations` generates a static or dynamic map of user-defined monitoring stations. The function accepts as input either an object of the `EEAaq_df` class (default output of the `EEAaq_get_data` function), or all other parameters specifying the area and the pollutants.


### Map the stations using as `EEAaq_df` object, the dataset concerning NO$_2$ and PM$_{10}$ in Belgium and The Netherlands
```{r}
EEAaq_map_stations(
  data = data,
  NUTS_extborder = "NUTS2",
  NUTS_intborder =  "NUTS3",
  color = FALSE,
  dynamic = FALSE
)
```
\
**Note**: Using the parameter `NUTS_intborder = "NUTS3"` and `NUTS_extborder = "NUTS2"`, the map is generated with internal boundaries corresponding to the NUTS-3 level and with regional (i.e., NUTS-2) external borders. The same output could be obtained specifying explicitly the zone information.

### Dynamic (interactive) map of all the PM$_{10}$ monitoring stations in Milano
```{r}
EEAaq_map_stations(
  data = data_lau,
  color = TRUE,
  dynamic = TRUE,
  ID = TRUE
)
```





# EEAaq summary
This function aims to describe the dataset that has been previously imported, both at a global level, which means considering the complete set of time stamps and monitoring stations in the dataset, and at the station-specific level, where summary statistics and information are grouped by monitoring station.
\
In addition to basic exploratory descriptive statistics (e.g., average pollutant concentration, variability, measures of skewness and kurtosis), the function provides information about the gap length and the correlation between pollutants if at least two pollutants are considered simultaneously.
\
The `EEAaq_summary` function receives as input an `EEAaq_df` object, i.e. the output of the EEAaq get data function.

### Compute the descriptive statistics
```{r}
summ <- EEAaq_summary(data = data)
```

### Print screen the global statsitics
```{r}
summ$Summary
```

### Print screen the station-specific statsitics
```{r}
summ$Summary_byStat$Mean_byStat
```

### Print screen the linear correlation matrix
```{r}
summ$Corr_Matrix
```





# EEAaq time aggregate
Recall that most pollutants are monitored by EEA on a hourly or daily basis, posing challenges for interpretation and representation. The `EEAaq_time_aggregate` function simplifies this by aggregating data into annual, monthly, weekly, daily, or hourly intervals, generating summary statistics for each station in an `EEAaq_taggr_df` object.

### Get the station-specific monthly minimum, maximum, average and median concentrations of NO$_2$ and PM$_{10}$ in Belgium and The Netherlands
```{r}
t_aggr <- EEAaq_time_aggregate(
  data = data,
  frequency = "monthly",
  aggr_fun = c("min", "max", "mean", "median" )
)
```

### Print screen of the aggregated (monthly) data
```{r}
t_aggr$TimeAggr
```

### Print screen of the PM$_{10}$ aggregated data only
```{r}
t_aggr$TimeAggr_byPollutant$PM10
```



# EEAaq_idw_map
To enable quick and intuitive visual analysis, the `EEAaq_idw_map` function provides spatial interpolation maps using the Inverse Distance Weighting (IDW) method (Shepard, 1968). This technique estimates the value of a variable at unknown locations by calculating a weighted average of known values, with weights inversely proportional to the distance from known points. Closer points contribute more heavily to the estimate, making it a practical approach for interpolating geolocated air quality data.

### Generate IDW interpolated maps of monthly average concentrations of NO$_2$ in the Netherlands and Belgium
```{r}
EEAaq::EEAaq_idw_map(
  data = t_aggr,
  NUTS_extborder = "NUTS2",
  NUTS_intborder = "NUTS3",
  pollutant = "PM10",
  aggr_fun = "mean",
  distinct = TRUE,
  gradient = TRUE,
  idp = 2
)
```


### Generate IDW interpolated maps of the maximum monthly concentrations of NO$_2$ in january and february 2023 in the Netherlands and Belgium
```{r}
EEAaq::EEAaq_idw_map(
  data = t_aggr$TimeAggr_byPollutant$PM10 %>% 
    dplyr::filter(Date %in% c("2023-01-01","2023-02-01")),
  NUTS_extborder = "NUTS3",
  NUTS_intborder = "LAU",
  pollutant = "PM10",
  aggr_fun = "max",
  dynamic = TRUE
)
```


### Generate IDW interpolated maps of monthly average concentrations of PM$_{10}$ in the Netherlands and Belgium
```{r}
EEAaq::EEAaq_idw_map(
  data = t_aggr$TimeAggr_byPollutant$PM10 %>% 
    dplyr::filter(Date %in% c("2023-01-01","2023-02-01","2023-03-01","2023-04-01")),
  NUTS_extborder = "NUTS2",
  NUTS_intborder = "NUTS3",
  pollutant = "PM10",
  aggr_fun = "mean",
  dynamic = TRUE
)
```
\
**Note**: By setting `fill_NUTS_level = "NUTS3"`, we require the predictions/interpolations to be aggregated (averaged) at the NUTS-3 level.

